<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Tech-Pro Assistant | CertainTeed Master Shingle Applicators</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ct-blue: #005EB8;
            --ct-blue-dark: #004A91;
            --ct-charcoal: #2D2D2D;
            --ct-slate: #4A4A4A;
            --ct-light: #F5F5F5;
            --ct-white: #FFFFFF;
            --ct-accent: #E8E8E8;
            --ct-success: #28A745;
            --ct-highlight: #FFF3CD;
            --gradient-blue: linear-gradient(135deg, #005EB8 0%, #004A91 100%);
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.1);
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: var(--ct-light); min-height: 100vh; display: flex; flex-direction: column; }
        
        header { background: linear-gradient(135deg, #1a1a1a 0%, #2D2D2D 100%); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .header-top { background: var(--ct-blue); padding: 6px 20px; display: flex; justify-content: space-between; }
        .header-top span { color: white; font-size: 12px; font-weight: 500; }
        .header-main { padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; width: 100%; }
        .logo-area { display: flex; align-items: center; gap: 16px; }
        .logo-icon { width: 48px; height: 48px; background: var(--ct-blue); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 28px; height: 28px; fill: white; }
        .logo-text h1 { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: white; letter-spacing: 2px; }
        .logo-text span { font-size: 11px; color: rgba(255,255,255,0.7); text-transform: uppercase; }
        .header-badge { background: rgba(0,94,184,0.2); border: 1px solid var(--ct-blue); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; }
        .badge-dot { width: 8px; height: 8px; background: var(--ct-success); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .header-badge span { color: white; font-size: 12px; }

        main { flex: 1; display: flex; max-width: 1400px; margin: 0 auto; width: 100%; padding: 20px; gap: 20px; }
        
        .sidebar { width: 320px; display: flex; flex-direction: column; gap: 16px; }
        .sidebar-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow-soft); overflow: hidden; }
        .sidebar-card-header { background: var(--ct-charcoal); padding: 14px 16px; display: flex; align-items: center; gap: 10px; }
        .sidebar-card-header svg { width: 18px; height: 18px; fill: white; }
        .sidebar-card-header h3 { font-family: 'Bebas Neue', sans-serif; font-size: 16px; color: white; letter-spacing: 1px; }
        .sidebar-card-content { padding: 16px; }
        .quick-actions { display: flex; flex-direction: column; gap: 8px; }
        .quick-action { background: var(--ct-light); border: 1px solid var(--ct-accent); padding: 12px; border-radius: 8px; cursor: pointer; text-align: left; font-size: 13px; color: var(--ct-slate); transition: all 0.2s; }
        .quick-action:hover { border-color: var(--ct-blue); transform: translateX(4px); }
        .chapters-list { max-height: 280px; overflow-y: auto; }
        .chapter-item { padding: 10px 12px; border-bottom: 1px solid var(--ct-accent); font-size: 12px; color: var(--ct-slate); cursor: pointer; display: flex; gap: 8px; }
        .chapter-item:hover { background: var(--ct-light); color: var(--ct-blue); }
        .chapter-num { font-weight: 700; color: var(--ct-blue); min-width: 20px; }

        .chat-area { flex: 1; background: white; border-radius: var(--radius); box-shadow: var(--shadow-soft); display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { background: var(--gradient-blue); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; }
        .chat-header h2 { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: white; }
        .chat-header p { font-size: 13px; color: rgba(255,255,255,0.85); }
        .chat-status { display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.2); padding: 6px 12px; border-radius: 20px; }
        .chat-status span { font-size: 11px; color: white; }

        .messages-container { flex: 1; overflow-y: auto; padding: 24px; background: linear-gradient(180deg, #fafafa, #f5f5f5); display: flex; flex-direction: column; gap: 16px; }
        .welcome-message { text-align: center; padding: 40px 20px; }
        .welcome-icon { width: 80px; height: 80px; background: var(--gradient-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(0,94,184,0.3); }
        .welcome-icon svg { width: 40px; height: 40px; fill: white; }
        .welcome-message h3 { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--ct-charcoal); margin-bottom: 8px; }
        .welcome-message p { color: var(--ct-slate); max-width: 500px; margin: 0 auto; line-height: 1.6; }

        .message { display: flex; gap: 12px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { flex-direction: row-reverse; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .message.assistant .message-avatar { background: var(--gradient-blue); }
        .message.user .message-avatar { background: var(--ct-charcoal); }
        .message-avatar svg { width: 18px; height: 18px; fill: white; }
        .message-content { max-width: 70%; padding: 14px 18px; border-radius: var(--radius); line-height: 1.6; font-size: 14px; }
        .message.assistant .message-content { background: white; box-shadow: var(--shadow-soft); border: 1px solid var(--ct-accent); }
        .message.user .message-content { background: var(--ct-charcoal); color: white; }
        .message-content strong { color: var(--ct-blue); }
        .message-content ul { margin: 10px 0; padding-left: 20px; }
        .message-content li { margin: 4px 0; }

        /* Source Documentation Box - Updated */
        .source-box { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid var(--ct-accent); border-left: 4px solid var(--ct-blue); border-radius: 0 8px 8px 0; padding: 14px 16px; margin-top: 16px; }
        .source-box-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .source-box-header svg { width: 18px; height: 18px; fill: var(--ct-blue); }
        .source-box-header span { font-family: 'Bebas Neue', sans-serif; font-size: 14px; color: var(--ct-charcoal); letter-spacing: 0.5px; }
        
        .source-item { background: white; border-radius: 8px; margin-bottom: 10px; overflow: hidden; border: 1px solid var(--ct-accent); }
        .source-item:last-child { margin-bottom: 0; }
        .source-item-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #f8f9fa; border-bottom: 1px solid var(--ct-accent); }
        .source-info { display: flex; flex-direction: column; gap: 2px; }
        .source-title { font-weight: 600; font-size: 13px; color: var(--ct-charcoal); }
        .source-id { font-size: 11px; color: var(--ct-blue); font-weight: 600; }
        .source-btn { display: inline-flex; align-items: center; gap: 6px; background: var(--ct-blue); color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; text-decoration: none; transition: all 0.2s; }
        .source-btn:hover { background: var(--ct-blue-dark); transform: translateY(-1px); }
        .source-btn svg { width: 12px; height: 12px; fill: white; }
        
        /* Quoted text with highlight */
        .source-quote { padding: 12px 14px; font-size: 13px; line-height: 1.6; color: var(--ct-slate); background: linear-gradient(90deg, var(--ct-highlight) 0%, rgba(255,243,205,0.3) 100%); border-left: 3px solid #ffc107; font-style: italic; }
        .source-quote::before { content: '"'; font-size: 18px; color: #ffc107; font-weight: bold; margin-right: 4px; }
        .source-quote::after { content: '"'; font-size: 18px; color: #ffc107; font-weight: bold; margin-left: 4px; }

        .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
        .typing-indicator span { width: 8px; height: 8px; background: var(--ct-slate); border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .input-area { padding: 20px 24px; border-top: 1px solid var(--ct-accent); }
        .input-wrapper { display: flex; gap: 12px; }
        .input-field { flex: 1; }
        .input-field textarea { width: 100%; padding: 14px 16px; border: 2px solid var(--ct-accent); border-radius: var(--radius); font-family: inherit; font-size: 14px; resize: none; min-height: 52px; }
        .input-field textarea:focus { outline: none; border-color: var(--ct-blue); }
        .send-btn { width: 52px; height: 52px; background: var(--gradient-blue); border: none; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,94,184,0.3); transition: transform 0.2s; }
        .send-btn:hover { transform: translateY(-2px); }
        .send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .send-btn svg { width: 22px; height: 22px; fill: white; }
        .input-hint { font-size: 11px; color: #999; margin-top: 8px; }
        .input-hint kbd { background: var(--ct-accent); padding: 2px 6px; border-radius: 4px; }

        footer { background: var(--ct-charcoal); padding: 16px 20px; text-align: center; }
        footer p { color: rgba(255,255,255,0.6); font-size: 12px; }
        footer a { color: white; }

        .beta-badge { background: #FF6B35; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; margin-left: 8px; }

        @media (max-width: 1024px) {
            main { flex-direction: column; }
            .sidebar { width: 100%; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <span>CERTAINTEED ROOFING PRODUCTS</span>
            <span>Technical Support: 800-345-1145</span>
        </div>
        <div class="header-main">
            <div class="logo-area">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.08 5.1 7.63 12 4.18zM4 8.9l7 3.5v7.7l-7-3.5V8.9zm9 11.2v-7.7l7-3.5v7.7l-7 3.5z"/></svg>
                </div>
                <div class="logo-text">
                    <h1>CT TECH-PRO ASSISTANT <span class="beta-badge">BETA</span></h1>
                    <span>Master Shingle Applicator Technical Guide</span>
                </div>
            </div>
            <div class="header-badge">
                <span class="badge-dot"></span>
                <span>AI-Powered Technical Support</span>
            </div>
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <div class="sidebar-card">
                <div class="sidebar-card-header">
                    <svg viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <h3>QUICK QUESTIONS</h3>
                </div>
                <div class="sidebar-card-content">
                    <div class="quick-actions">
                        <button class="quick-action" onclick="sendQuestion('Where do I install drip edge - over or under the underlayment?')">üìå Drip edge installation position</button>
                        <button class="quick-action" onclick="sendQuestion('What are the dimensions of Landmark shingles?')">üìê Landmark shingle dimensions</button>
                        <button class="quick-action" onclick="sendQuestion('What are the ventilation requirements using the 1/300 rule?')">üí® Ventilation 1/300 rule requirements</button>
                        <button class="quick-action" onclick="sendQuestion('What hip and ridge accessories can I use with Carriage House?')">üè† Carriage House hip/ridge</button>
                    </div>
                </div>
            </div>
            <div class="sidebar-card">
                <div class="sidebar-card-header">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <h3>MANUAL CHAPTERS</h3>
                </div>
                <div class="sidebar-card-content">
                    <div class="chapters-list">
                        <div class="chapter-item" onclick="sendQuestion('Summarize Chapter 1 on safety and workmanship guidelines.')"><span class="chapter-num">1</span>Safety, Workmanship & Repairs</div>
                        <div class="chapter-item" onclick="sendQuestion('What shingle specs and warranties are covered in Chapter 2?')"><span class="chapter-num">2</span>Shingle Specs & Warranties</div>
                        <div class="chapter-item" onclick="sendQuestion('How do I estimate roof covering from Chapter 3?')"><span class="chapter-num">3</span>Estimating Roof Covering</div>
                        <div class="chapter-item" onclick="sendQuestion('When should I tear off vs roof over per Chapter 4?')"><span class="chapter-num">4</span>Roof Decks (Tear-off vs. Over)</div>
                        <div class="chapter-item" onclick="sendQuestion('Explain WinterGuard and drip edge requirements from Chapter 5.')"><span class="chapter-num">5</span>Shingle Underlayments</div>
                        <div class="chapter-item" onclick="sendQuestion('What are the valley and chimney flashing requirements from Chapter 6?')"><span class="chapter-num">6</span>Flashing, Valleys & Chimneys</div>
                        <div class="chapter-item" onclick="sendQuestion('What are the ventilation standards from Chapter 7?')"><span class="chapter-num">7</span>Ventilation Standards</div>
                        <div class="chapter-item" onclick="sendQuestion('What are correct nailing patterns from Chapter 8?')"><span class="chapter-num">8</span>Correct Fastening</div>
                        <div class="chapter-item" onclick="sendQuestion('How do I shingle hip roofs and cones from Chapter 9?')"><span class="chapter-num">9</span>Special Shaped Roofs</div>
                        <div class="chapter-item" onclick="sendQuestion('What are XT-25 three-tab installation requirements?')"><span class="chapter-num">10</span>XT‚Ñ¢-25 (Three-Tab)</div>
                        <div class="chapter-item" onclick="sendQuestion('What are Landmark Series installation specs?')"><span class="chapter-num">11</span>Landmark¬Æ Series</div>
                        <div class="chapter-item" onclick="sendQuestion('What are Landmark TL installation requirements?')"><span class="chapter-num">12</span>Landmark¬Æ TL</div>
                        <div class="chapter-item" onclick="sendQuestion('What are NorthGate ClimateFlex requirements?')"><span class="chapter-num">13</span>NorthGate¬Æ ClimateFlex¬Æ</div>
                        <div class="chapter-item" onclick="sendQuestion('What are Presidential Shake installation specs?')"><span class="chapter-num">14</span>Presidential Shake¬Æ</div>
                        <div class="chapter-item" onclick="sendQuestion('How do I install Highland Slate shingles?')"><span class="chapter-num">15</span>Highland Slate¬Æ</div>
                        <div class="chapter-item" onclick="sendQuestion('What are Belmont installation requirements?')"><span class="chapter-num">16</span>Belmont¬Æ</div>
                        <div class="chapter-item" onclick="sendQuestion('What are Grand Manor and Carriage House requirements?')"><span class="chapter-num">17</span>Grand Manor¬Æ & Carriage House¬Æ</div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="chat-area">
            <div class="chat-header">
                <div>
                    <h2>TECHNICAL ASSISTANT</h2>
                    <p>Expert installation specs with highlighted source references</p>
                </div>
                <div class="chat-status">
                    <span class="badge-dot"></span>
                    <span>Ready</span>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg>
                    </div>
                    <h3>Welcome to CT Tech-Pro Assistant</h3>
                    <p>Your official technical guide for CertainTeed roofing products. Ask about installation specifications, warranty requirements, fastening patterns, and more. Each answer includes highlighted source quotes.</p>
                </div>
            </div>
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-field">
                        <textarea id="userInput" placeholder="Ask a technical question about CertainTeed shingles..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
                <div class="input-hint"><kbd>Enter</kbd> to send ¬∑ <kbd>Shift+Enter</kbd> for new line</div>
            </div>
        </section>
    </main>
    <footer><p>CT Tech-Pro Assistant ¬∑ CertainTeed MSA Manual 16th Edition ¬∑ <a href="https://www.certainteed.com" target="_blank">certainteed.com</a></p></footer>

    <script>
// Chapter PDF mapping - CertainTeed Showpad links
const CHAPTER_PDFS = {
    1: { file: 'https://certainteed.showpad.com/share/4c4D302Vg8towszBfNboE', title: 'Chapter 1: Safety, Workmanship & Repairs' },
    2: { file: 'https://certainteed.showpad.com/share/tPLJYSrxJ7VB7cakgUBFp', title: 'Chapter 2: Shingle Specs, Performance & Warranties' },
    3: { file: 'https://certainteed.showpad.com/share/heeCUsyniNv1h5WfojV25', title: 'Chapter 3: Estimating Roof Covering' },
    4: { file: 'https://certainteed.showpad.com/share/wc0YjCmOmpmkimyicSxs4', title: 'Chapter 4: Roof Decks' },
    5: { file: 'https://certainteed.showpad.com/share/F9ehftyeRDj6gmrBpkR9B', title: 'Chapter 5: Shingle Underlayments' },
    6: { file: 'https://certainteed.showpad.com/share/49Jq2WdWMcUgR9BdS9osB', title: 'Chapter 6: Flashing, Valleys, Walls & Chimneys' },
    7: { file: 'https://certainteed.showpad.com/share/8o6G0AAcEc3Tm7WwjWe3Y', title: 'Chapter 7: Ventilation Standards' },
    8: { file: 'https://certainteed.showpad.com/share/7Md6P7cNPlB5ilkWAafTh', title: 'Chapter 8: Correct Fastening' },
    9: { file: 'https://certainteed.showpad.com/share/cpOEY6aoRHIMVwgP1qG8w', title: 'Chapter 9: Special Shaped Roofs' },
    10: { file: 'https://certainteed.showpad.com/share/IL2o2YKqhfCyHDGDWyzOP', title: 'Chapter 10: XT-25 Three-Tab' },
    11: { file: 'https://certainteed.showpad.com/share/eHnBWa4l1qcLCEFbMY5Yi', title: 'Chapter 11: Landmark Series' },
    12: { file: 'https://certainteed.showpad.com/share/ZgPq1C3XLJh5XaxlrXj5d', title: 'Chapter 12: Landmark TL' },
    13: { file: 'https://certainteed.showpad.com/share/Jp4SWy4RlOteWhjE7heRV', title: 'Chapter 13: NorthGate ClimateFlex' },
    14: { file: 'https://certainteed.showpad.com/share/JwnosNSvQLtF3HMniyXex', title: 'Chapter 14: Presidential Shake' },
    15: { file: 'https://certainteed.showpad.com/share/tUChjDoGforQpGwxATBGx', title: 'Chapter 15: Highland Slate' },
    16: { file: 'https://certainteed.showpad.com/share/xPmXFt2bQIxoaI1CEzJ4V', title: 'Chapter 16: Belmont' },
    17: { file: 'https://certainteed.showpad.com/share/pgLmiLn11fe0jZs2zlXWR', title: 'Chapter 17: Grand Manor & Carriage House' },
    'patriot': { file: 'https://certainteed.showpad.com/share/RtbgmsykwSwAFARubhdDt', title: 'Patriot Standard Installation' },
    'patriot-xl': { file: 'https://certainteed.showpad.com/share/FEkmWnKtLYVEFemxqKyl9', title: 'Patriot XL Installation' },
    'warranty': { file: '', title: '2025 Limited Warranty' },
    'warranty': { file: '', title: '2025 Asphalt Shingle Limited Warranty' },
    'warranty-2025': { file: '', title: '2025 Asphalt Shingle Limited Warranty' },
    'tds-landmark': { file: '', title: 'Landmark Series Technical Data Sheet' },
    'tds-belmont': { file: '', title: 'Belmont AR IR Technical Data Sheet' },
    'tds-carriage': { file: '', title: 'Carriage House Technical Data Sheet' },
    'tds-climateflex': { file: '', title: 'Landmark ClimateFlex Technical Data Sheet' },
    'tds-vycor': { file: '', title: 'Vycor Ice & Water Shield Technical Data Sheet' },
    'tds-vycor-ht': { file: '', title: 'Vycor Ice & Water Shield HT Technical Data Sheet' },
    'tds-vycor-select': { file: '', title: 'Vycor Select Technical Data Sheet' },
    'tds-vycor-ultra': { file: '', title: 'Vycor Ultra Technical Data Sheet' },
    'tis-103': { file: '', title: 'TIS 103: Drip Edge Overhang' },
    'tis-107': { file: '', title: 'TIS 107: Application Does Not Void Warranty' },
    'tis-108': { file: '', title: 'TIS 108: Cold Weather Application' },
    'tis-109': { file: '', title: 'TIS 109: WinterGuard over Competitor WSU' },
    'tis-111': { file: '', title: 'TIS 111: Solvent Damage' },
    'tis-114': { file: '', title: 'TIS 114: Hot Weather/Scuffing Damage' },
    'tis-118': { file: '', title: 'TIS 118: Fire Damage' },
    'tis-119': { file: '', title: 'TIS 119: Sealing/Re-sealing Shingles' },
    'tis-125': { file: '', title: 'TIS 125: Tear Off vs Roof Over' },
    'tis-130': { file: '', title: 'TIS 130: Hail Damage' },
    'tis-133': { file: '', title: 'TIS 133: Tectum Deck Panels' },
    'tis-138': { file: '', title: 'TIS 138: Drip Edge and Underlayment' },
    'tis-144': { file: '', title: 'TIS 144: Algae, Moss and Lichens' },
    'tis-151': { file: '', title: 'TIS 151: Discontinued Products' },
    'tis-155': { file: '', title: 'TIS 155: Unvented/Insulated Decks Warranty' },
    'tis-159': { file: '', title: 'TIS 159: Ice Dams' },
    'tis-160': { file: '', title: 'TIS 160: Huber ZIP System' },
    'tis-168': { file: '', title: 'TIS 168: Roof Deck Spacing' },
    'tis-207': { file: '', title: 'TIS 207: Roof Penetrations' },
    'tis-211': { file: '', title: 'TIS 211: Storage and Pallet Stacking' },
    'tis-252': { file: '', title: 'TIS 252: Appearance Variation on New Roof' },
    'tis-257': { file: '', title: 'TIS 257: Extreme Weather Wind Warranty' },
    'tis-266': { file: '', title: 'TIS 266: Painting or Coating Shingles' },
    'tis-278': { file: '', title: 'TIS 278: Re-Use of Shingles for Repairs' },
    'tis-281': { file: '', title: 'TIS 281: Storm Damaged Shingles' }
};

let history = [];
let loading = false;

const API_ENDPOINT = '/api/chat';

async function callAPI(msg) {
    history.push({role: "user", content: msg});
    
    const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ messages: history })
    });
    
    if (!res.ok) {
        const error = await res.json();
        throw new Error(error.details || `API error: ${res.status}`);
    }
    
    const data = await res.json();
    const reply = data.content[0].text;
    history.push({role: "assistant", content: reply});
    return reply;
}

function parseSourceRefs(text) {
    // Look for SOURCE_REFS_START ... SOURCE_REFS_END block
    const blockMatch = text.match(/SOURCE_REFS_START\s*([\s\S]*?)\s*SOURCE_REFS_END/);
    
    if (!blockMatch) {
        // Fallback to old format
        const oldMatch = text.match(/SOURCE_REFS:\[([^\]]+)\]\|([^|]*)\|?(.*)?/);
        if (oldMatch) {
            const cleanText = text.replace(/SOURCE_REFS:\[([^\]]+)\]\|([^|]*)\|?(.*)?/, '').trim();
            return { cleanText, sources: [] };
        }
        return { cleanText: text, sources: [] };
    }
    
    const cleanText = text.replace(/SOURCE_REFS_START\s*[\s\S]*?\s*SOURCE_REFS_END/, '').trim();
    const refsBlock = blockMatch[1];
    
    // Parse each line: [source_id]|[title]|[quote]
    const lines = refsBlock.split('\n').filter(line => line.trim());
    const sources = lines.map(line => {
        const match = line.match(/\[([^\]]+)\]\|([^|]+)\|(.+)/);
        if (!match) return null;
        
        const sourceId = match[1].trim();
        const title = match[2].trim();
        const quote = match[3].trim();
        
        // Get PDF link from mapping
        const chapterData = CHAPTER_PDFS[sourceId] || CHAPTER_PDFS[parseInt(sourceId)];
        
        return {
            id: sourceId,
            title: title,
            quote: quote,
            chapterTitle: chapterData?.title || `Source: ${sourceId}`,
            file: chapterData?.file || ''
        };
    }).filter(s => s !== null);
    
    return { cleanText, sources };
}

function generateSourceBox(sources) {
    if (!sources || sources.length === 0) return '';
    
    const sourceItems = sources.map(s => {
        const linkBtn = s.file ? `
            <a href="${s.file}" target="_blank" class="source-btn">
                <svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                View PDF
            </a>
        ` : '';
        
        return `
            <div class="source-item">
                <div class="source-item-header">
                    <div class="source-info">
                        <span class="source-id">${s.chapterTitle}</span>
                        <span class="source-title">${s.title}</span>
                    </div>
                    ${linkBtn}
                </div>
                <div class="source-quote">${s.quote}</div>
            </div>
        `;
    }).join('');
    
    return `
        <div class="source-box">
            <div class="source-box-header">
                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zm-3 5h6v2h-6v-2zm0 4h6v2h-6v-2zm-2-8h2v2H8v-2z"/></svg>
                <span>SOURCE DOCUMENTATION</span>
            </div>
            ${sourceItems}
        </div>
    `;
}

function format(text) {
    return text
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>[\s\S]*?<\/li>)+/g, '<ul>$&</ul>')
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');
}

function escape(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

async function sendMessage() {
    if (loading) return;
    const input = document.getElementById('userInput');
    const msg = input.value.trim();
    if (!msg) return;
    
    const welcome = document.getElementById('welcomeMessage');
    if (welcome) welcome.remove();
    
    const container = document.getElementById('messagesContainer');
    container.innerHTML += `<div class="message user"><div class="message-avatar"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="message-content">${escape(msg)}</div></div>`;
    input.value = '';
    
    const typingId = 'typing-' + Date.now();
    container.innerHTML += `<div class="message assistant" id="${typingId}"><div class="message-avatar"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg></div><div class="message-content"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`;
    container.scrollTop = container.scrollHeight;
    
    loading = true;
    document.getElementById('sendBtn').disabled = true;
    
    try {
        const reply = await callAPI(msg);
        const { cleanText, sources } = parseSourceRefs(reply);
        const formattedText = format(cleanText);
        const sourceBox = generateSourceBox(sources);
        document.getElementById(typingId).querySelector('.message-content').innerHTML = formattedText + sourceBox;
    } catch(e) {
        document.getElementById(typingId).querySelector('.message-content').innerHTML = `<span style="color:#C62828">Error: ${e.message}. Please try again.</span>`;
    }
    
    loading = false;
    document.getElementById('sendBtn').disabled = false;
    container.scrollTop = container.scrollHeight;
}

function sendQuestion(q) {
    document.getElementById('userInput').value = q;
    sendMessage();
}

function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}
    </script>
</body>
</html>